{% extends "base.html" %}
{% load static %}

{% block title %}Manage Users{% endblock %}

{% block content %}
<section class="users-management">
  <div class="container">
    <div class="row">
      <!-- Header -->
      <div class="col-12">
        <div class="users-header">
          <div class="users-header-content">
            <h1><i class="fas fa-users"></i> User Management</h1>
            <p>Manage user accounts and permissions</p>
          </div>
          <div class="users-header-actions">
            <a href="{% url 'admin_dashboard' %}" class="users-back-link">
              <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Users List -->
    <div class="row">
      <div class="col-12">
        <div class="users-list-card">
          <div class="users-list-header">
            <h5>All Users</h5>
            <div class="users-filters">
              <select class="users-filter-select" id="statusFilter">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="staff">Staff</option>
              </select>
              <input type="text" class="users-search-input" id="searchInput" placeholder="Search users...">
            </div>
          </div>
          <div class="users-list-body">
            <div class="users-table-container">
              <table class="users-table">
                <thead>
                  <tr>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Full Name</th>
                    <th>Status</th>
                    <th>Joined</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="usersTable">
                  {% for user in users %}
                  <tr>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.get_full_name|default:"-" }}</td>
                    <td>
                      {% if user.is_active %}
                        <span class="users-badge users-badge-active">Active</span>
                        {% if user.is_staff %}
                          <span class="users-badge users-badge-staff">Staff</span>
                        {% endif %}
                      {% else %}
                        <span class="users-badge users-badge-inactive">Inactive</span>
                      {% endif %}
                    </td>
                    <td>{{ user.date_joined|date:"M d, Y" }}</td>
                    <td>
                      <div class="users-actions">
                        {% if user.is_active %}
                        <button type="button" class="users-action-btn users-action-deactivate"
                                onclick="toggleUserStatus({{ user.pk }}, false, '{{ user.username }}')">
                          <i class="fas fa-user-times"></i>
                        </button>
                        {% else %}
                        <button type="button" class="users-action-btn users-action-activate"
                                onclick="toggleUserStatus({{ user.pk }}, true, '{{ user.username }}')">
                          <i class="fas fa-user-check"></i>
                        </button>
                        {% endif %}
                        {% if not user.is_staff %}
                        <button type="button" class="users-action-btn users-action-make-staff"
                                onclick="toggleStaffStatus({{ user.pk }}, true, '{{ user.username }}')">
                          <i class="fas fa-user-shield"></i>
                        </button>
                        {% else %}
                        <button type="button" class="users-action-btn users-action-remove-staff"
                                onclick="toggleStaffStatus({{ user.pk }}, false, '{{ user.username }}')">
                          <i class="fas fa-user"></i>
                        </button>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="6">
                      <div class="users-empty-state">
                        <i class="fas fa-users users-empty-icon"></i>
                        <h6 class="users-empty-title">No users found</h6>
                        <p class="users-empty-text">There are currently no users in the system.</p>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            {% if users.has_other_pages %}
            <nav aria-label="User pagination">
              <ul class="pagination justify-content-center">
                {% if users.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ users.previous_page_number }}">Previous</a>
                </li>
                {% endif %}

                {% for num in users.paginator.page_range %}
                {% if users.number == num %}
                <li class="page-item active">
                  <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                </li>
                {% elif num > users.number|add:'-3' and num < users.number|add:'3' %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                </li>
                {% endif %}
                {% endfor %}

                {% if users.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ users.next_page_number }}">Next</a>
                </li>
                {% endif %}
              </ul>
            </nav>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Status Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content users-modal">
      <div class="modal-header users-modal-header">
        <h5 class="modal-title users-modal-title">Change User Status</h5>
        <button type="button" class="btn-close users-modal-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body users-modal-body">
        <p>Are you sure you want to <span id="statusAction"></span> the user "<span id="userName"></span>"?</p>
        <div class="users-alert users-alert-info">
          <strong>Note:</strong> <span id="statusMessage"></span>
        </div>
      </div>
      <div class="modal-footer users-modal-footer">
        <button type="button" class="users-modal-btn users-modal-btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="users-modal-btn users-modal-btn-primary" id="confirmStatusChange">Confirm</button>
      </div>
    </div>
  </div>
</div>

<!-- Staff Modal -->
<div class="modal fade" id="staffModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content users-modal">
      <div class="modal-header users-modal-header">
        <h5 class="modal-title users-modal-title">Change Staff Status</h5>
        <button type="button" class="btn-close users-modal-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body users-modal-body">
        <p>Are you sure you want to <span id="staffAction"></span> staff privileges for "<span id="staffUserName"></span>"?</p>
        <div class="users-alert users-alert-warning">
          <strong>Warning:</strong> <span id="staffMessage"></span>
        </div>
      </div>
      <div class="modal-footer users-modal-footer">
        <button type="button" class="users-modal-btn users-modal-btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="users-modal-btn users-modal-btn-primary" id="confirmStaffChange">Confirm</button>
      </div>
    </div>
  </div>
</div>

<script>
function toggleUserStatus(userId, activate, username) {
  const action = activate ? 'activate' : 'deactivate';
  const message = activate ?
    'This user will be able to log in and use the site.' :
    'This user will not be able to log in until reactivated.';

  document.getElementById('statusAction').textContent = action;
  document.getElementById('userName').textContent = username;
  document.getElementById('statusMessage').textContent = message;

  document.getElementById('confirmStatusChange').onclick = function() {
    const form = document.createElement('form');
    form.method = 'POST';
    form.innerHTML = `
      {% csrf_token %}
      <input type="hidden" name="toggle_user" value="${userId}">
      <input type="hidden" name="activate" value="${activate}">
    `;
    document.body.appendChild(form);
    form.submit();
  };
  new bootstrap.Modal(document.getElementById('statusModal')).show();
}

function toggleStaffStatus(userId, makeStaff, username) {
  const action = makeStaff ? 'grant' : 'revoke';
  const message = makeStaff ?
    'This user will have access to the admin dashboard.' :
    'This user will lose access to the admin dashboard.';

  document.getElementById('staffAction').textContent = action;
  document.getElementById('staffUserName').textContent = username;
  document.getElementById('staffMessage').textContent = message;

  document.getElementById('confirmStaffChange').onclick = function() {
    const form = document.createElement('form');
    form.method = 'POST';
    form.innerHTML = `
      {% csrf_token %}
      <input type="hidden" name="toggle_staff" value="${userId}">
      <input type="hidden" name="make_staff" value="${makeStaff}">
    `;
    document.body.appendChild(form);
    form.submit();
  };
  new bootstrap.Modal(document.getElementById('staffModal')).show();
}

// Search functionality
document.getElementById('searchInput').addEventListener('input', function() {
  const searchTerm = this.value.toLowerCase();
  const rows = document.querySelectorAll('#usersTable tr');

  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(searchTerm) ? '' : 'none';
  });
});

// Status filter functionality
document.getElementById('statusFilter').addEventListener('change', function() {
  const status = this.value;
  const rows = document.querySelectorAll('#usersTable tr');

  rows.forEach(row => {
    if (!status) {
      row.style.display = '';
      return;
    }

    const badges = row.querySelectorAll('.users-badge');
    let showRow = false;

    badges.forEach(badge => {
      if ((status === 'active' && badge.classList.contains('users-badge-active')) ||
          (status === 'inactive' && badge.classList.contains('users-badge-inactive')) ||
          (status === 'staff' && badge.classList.contains('users-badge-staff'))) {
        showRow = true;
      }
    });

    row.style.display = showRow ? '' : 'none';
  });
});

// Form focus effects
document.querySelectorAll('.users-filter-select, .users-search-input').forEach(input => {
  input.addEventListener('focus', function() {
    this.style.borderColor = '#8b7ba8';
    this.style.boxShadow = '0 0 0 2px rgba(139, 123, 168, 0.1)';
  });

  input.addEventListener('blur', function() {
    this.style.borderColor = '#e0e0e0';
    this.style.boxShadow = 'none';
  });
});
</script>

{% endblock %}
